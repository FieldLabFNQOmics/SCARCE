% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/find_somatic_variants.R
\name{find_somatic_variants}
\alias{find_somatic_variants}
\title{find_somatic_variants.R}
\usage{
find_somatic_variants(
  h5_in = NULL,
  vcf_in = NULL,
  prep_vcf = F,
  prep_vcf_dir = NULL,
  cell_type = "all",
  cell_annotations = NULL,
  out_dir,
  file_prefix,
  skip_vep = F,
  priority_only = F,
  block = 1000,
  min_DP_per_call = 10,
  min_GQ_per_call = 30,
  min_varcount_total = 30,
  min_varportion_total = 0,
  max_varportion_total = 0.7,
  min_datacount_total = 100,
  min_dataportion_total = 0.25,
  min_quality_mean_total = 0.3,
  min_allelefreq_mean_total = 0,
  min_allelefreq_mean_mutants = 0.1,
  rare_cutoff = 0.02,
  min_varcount_celltype = 1,
  min_varportion_celltype = 0,
  min_datacount_celltype = 1,
  min_varportion_in_celltype = 0,
  max_p_value = 1,
  odds_ratio_cutoff = -1000,
  zscore_cutoff = 0,
  celltype_sort_value = "p",
  overwrite_variant_summary = TRUE,
  overwrite_celltype_enrichment = TRUE,
  run_cell_type_enrichment = TRUE,
  genome_version = "hg19",
  threads = 4,
  use_vep_file = NULL
)
}
\arguments{
\item{h5_in}{Path to input MissionBio Tapestri \code{.h5} file. Provide this OR \code{vcf_in}.}

\item{vcf_in}{Path to input multi-sample VCF (\code{.vcf.gz}) with \code{.tbi} index. If a plain \code{.vcf}
is provided and \code{prep_vcf=TRUE}, it will be bgzipped and indexed into \code{prep_vcf_dir}.}

\item{prep_vcf}{Logical; if \code{TRUE} and \code{vcf_in} is an uncompressed \code{.vcf}, create a
bgzipped and tabix-indexed copy before processing.}

\item{prep_vcf_dir}{Directory to write the prepared \verb{*.vcf.gz} and \verb{*.tbi} when
\code{prep_vcf=TRUE}. Defaults to the directory of \code{vcf_in} if \code{NULL}.}

\item{cell_type}{Character vector of cell-type labels to test for variant enrichment. Use \code{"all"}
to test every cell type present in \code{cell_annotations}. Only types present are used.}

\item{cell_annotations}{Named vector (length = number of cells) mapping barcode
(names) → cell-type (values). Barcodes are matched to VCF/H5 samples; common
prefix/suffix is auto-trimmed if needed.}

\item{out_dir}{Output directory for all result files.}

\item{file_prefix}{Prefix used to name output files (e.g., \code{"<prefix>_summary.tsv"}).}

\item{skip_vep}{Logical; if \code{TRUE}, skip VEP annotation and priority variant
detection. Disables \code{priority_only} filtering.}

\item{priority_only}{Logical; if \code{TRUE}, restrict downstream outputs to variants
flagged as priority by VEP (rare protein-impacting). Ignored when \code{skip_vep=TRUE}.}

\item{block}{Integer; number of variants per processing chunk for memory efficiency.}

\item{min_DP_per_call}{Minimum depth (DP) for a per-cell genotype to be considered;
calls failing are masked (\code{AF=NA}, \code{NGT=3}).}

\item{min_GQ_per_call}{Minimum genotype quality (GQ) for a per-cell genotype to be
considered; calls failing are masked (\code{AF=NA}, \code{NGT=3}).}

\item{min_varcount_total}{Minimum number of mutant cells (NGT \%in\% 1,2) across all cells.}

\item{min_varportion_total}{Minimum fraction of mutant among informative cells
(alt_cnt_total / data_cnt_total) required globally.}

\item{max_varportion_total}{Maximum allowed global mutant fraction (to exclude
likely germline/high-frequency sites).}

\item{min_datacount_total}{Minimum number of cells with informative data globally.}

\item{min_dataportion_total}{Minimum fraction of cells with informative data globally.}

\item{min_quality_mean_total}{Minimum mean GQ across cells with AF>0.}

\item{min_allelefreq_mean_total}{Minimum mean AF across cells with AF>0.}

\item{min_allelefreq_mean_mutants}{Minimum mean AF among mutant cells only
(NGT \%in\% 1,2).}

\item{rare_cutoff}{MAX_AF threshold used with VEP (e.g., 0.01–0.05). Variants with
MAX_AF < cutoff or with missing MAX_AF are treated as “rare/unreported” for
priority calls.}

\item{min_varcount_celltype}{Minimum number of mutant cells within the focal cell type.}

\item{min_varportion_celltype}{Minimum mutant fraction within the focal cell type
(alt_cnt_ct / data_cnt_ct).}

\item{min_datacount_celltype}{Minimum number of informative cells within the focal type.}

\item{min_varportion_in_celltype}{Minimum fraction of all mutant cells that fall
inside the focal type (alt_cnt_ct / alt_cnt_total), i.e., enrichment within type.}

\item{max_p_value}{Maximum adjusted p-value (BH) to keep in cell-type enrichment results.}

\item{odds_ratio_cutoff}{Minimum odds ratio threshold for enrichment (set negative
to disable).}

\item{zscore_cutoff}{Minimum Wald Z-score threshold for enrichment (set ≤0 to disable).}

\item{celltype_sort_value}{Sorting key for per-cell-type result tables; \code{"p"}
sorts by adjusted p-value ascending (default). \code{"z"} sorts by descending z-score.}

\item{overwrite_variant_summary}{Logical; overwrite existing global summary files
(\verb{*_summary.tsv}, \verb{*_summary_pass_only.tsv}, etc.) if present.}

\item{overwrite_celltype_enrichment}{Logical; overwrite existing per-cell-type files
if present.}

\item{run_cell_type_enrichment}{Logical; if \code{TRUE}, compute per-cell-type counts,
odds ratios, p-values, adjust p-values, and write \code{"<prefix>_<celltype>.tsv"}
and filtered variants.}

\item{genome_version}{Genome identifier passed to VariantAnnotation when reading VCF
(e.g., \code{"hg19"}, \code{"GRCh38"}). Must match contigs in the input VCF.}

\item{threads}{Number of threads to use where parallelism is available. (Most
operations here are chunked; heavy parallelism occurs upstream/downstream.)}

\item{use_vep_file}{Path to existing VEP annotation file to use}
}
\description{
Find variants enriched in one or more annotated cell types from a Tapestri
H5 or a multi-sample VCF. Exactly one of \code{h5_in} or \code{vcf_in} must be supplied.
Writes summary tables, per-cell genotypes, and (optionally) per-cell-type
enrichment stats to \code{out_dir} using \code{file_prefix}.
}
